---
title: 思路
date: 2017-4-29 15:51:29
categories: 随文
tags: 技术
toc: true
---

## 基于一次python代码排错的思考

### 排错过程

最近为了完成公司给的一个需求：写一个脚本把静态资源上传至七牛云，支持增量上传。这个问题不算太难，在七牛的官网有对应的sdk（[七牛python-sdk文档](https://developer.qiniu.com/kodo/sdk/1242/python)），于是自己先写了一个上传脚本，不是很满意，于是去网上找了看有没有写得好的上传工具。然后找到一个不错的脚本，于是开始在其基础上修改代码，实现了下载，上传（包括增量上传），刷新缓存，校对文件的功能，满足了工作中的需求。


<!-- more -->

后来在实际使用中发现一个bug，当上传的文件是更新文件时，会出现第一个文件可以上传，但是后面的文件代码会返回400的错误：


`
None exception:None, status_code:400, _ResponseInfo__response:<Response [400]>,
text_body:, req_id:lCoAAIeThw9czLkU, error:unknown, x_log:body/request Content-Type isn't multi;UP/400
`

其实这个错误已经很明显了，问题就是出现在头信息上，但是习惯于Google的我并没有仔细思考错误就直接网上搜索各种解决办法，然后在官网看到400错误是指**请求报文格式错误，报文构造不正确或者没有完整发送**，其实这么一句话也能说明调用的接口传递的参数不对。由于没有排错经验的我，还是没有找到正确的处理方式，还是一味地去Google想看看能不能侥幸地找到答案，然而Google这次没能帮到我。如果我不解决这个问题，那么我的脚本就存在一个致命的问题，我需要把七牛存在的文件删除之后才能正确上传，显然不能容忍这个情况。那就必须解决问题，于是开始了调试过程，使用七牛的测试空间不停调试。首先从脚本开始排错，把上传接口返回的信息都打印出来。当时奇怪的问题是：在同一个for循环中，第一个上传更新可以正确返回，但是后面的上传更新都返回400，每次执行脚本都是这样。当时觉得很奇怪，在同一个for循环怎么可能出现不同的结果，查看了自己的代码，更新文件的逻辑就比上传的逻辑多了一个文件hash值得判断。看了取hash值的这块逻辑发现和更新和上传没什么关系。所以判断我上传和更新是一样的，于是我开始怀疑sdk是否有问题，因为是报的http的错误，而http的请求都是封装在sdk中的。于是又去官网下载了python-sdk的源码开始排错，各种调试，看到底是哪个地方没有传对参数。

由于自己的python功力不太好，看起源码来还是很吃力的，但是没办法需要慢慢排查，打印各种信息和官网给的数据格式对比，发现并没什么异常。后来我抛开其他信息，只看源码。

我把http的post接口数据全部打印出来，我想分析for循环第一个值和其他值到底有何不同。果然我在post接口数据中发现了headers这个参数不一致，第一个值没有`{'Content-Type': 'application/json'}`，而后面的值都有这个头信息，所以问题找到了，和报错一致。紧接着分析是在什么地方传入了这个头信息，我发现我调用上传接口之后紧接着调用了清除缓存的接口，而在清除缓存的接口给头信息添加了这个头。但是上传和清除缓存是调用的不同的函数，怎么会把头信息加到上传接口呢？进一步分析发现headers是一个全局的字典，但是我看了函数中是使用了copy的，因此不存在修改元数据的情况。这一点让我百思不得其解，然后我又去服务器上看了python的模块，突然发现模块里面没有加copy。一切都迎刃而解，最终原因是pip安装的库和七牛官网提供的源码不一致，pip安装的库少了copy。

### 思考

如果对于一个开发高手来说，也许很快就能定位到问题。但是对于我这个运维人员来说，并没有形成开发思维，也没有形成系统的bug解决思维。再加上自己太过依赖Google，所以这个问题浪费了我一天的时间，最终得到解决。这让我明白，解决问题的思路的正确性多么重要。漫无目的在海量的Google页面搜索不会提高解决问题的速度，反而陷入困境之中。得到错误之后应该从错误入手，不要想当然的认为其他哪里有问题。

### 总结

这让我明白，思维对于一个技术人员是多么的重要，要敢于相信自己，依靠自己的能力解决问题，不要一味地依赖外部的帮助。做人也是一样的，只有自己强大了，才能游刃有余，处之泰然。之所以高手都是大隐隐于市，浮躁不能解决任何问题。
